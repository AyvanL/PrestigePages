<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Your Cart</title>
  <link rel="stylesheet" href="css/homepage.css" />
</head>
<body>

  <!-- ðŸ”¹ Navbar -->
  <header class="site-header">
      <div class="container nav">
        <button
          class="icon-btn hamburger"
          id="navToggle"
          aria-label="Open menu"
        >
          <svg
            width="20"
            height="20"
            viewBox="0 0 24 24"
            fill="none"
            xmlns="http://www.w3.org/2000/svg"
          >
            <path
              d="M3 6h18M3 12h18M3 18h18"
              stroke="#5f5a54"
              stroke-width="2"
              stroke-linecap="round"
            />
          </svg>
        </button>
        <div class="brand">PrestigePages</div>
        <nav class="nav-links" aria-label="Main">
          <a href="homepage-logged.html">Home</a>
          <a href="#popular">Store</a>
          <a href="about-us-logged.html">About us</a>
        </nav>

        <div class="nav-spacer"></div>

        <div class="actions">
          <button class="icon-btn" aria-label="Wishlist">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M12.1 20.3 4.7 13c-2.6-2.6-1.9-6.9 1.6-8.5 1.7-.8 3.7-.5 5.1.7 1.4-1.2 3.4-1.5 5.1-.7 3.5 1.6 4.2 5.9 1.6 8.5l-7.3 7.3Z"
                stroke="#7E6E5B"
                stroke-width="1.6"
                fill="#fff"
              />
            </svg>
          </button>

           <button id="cartBtn" class="icon-btn" aria-label="Cart">
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                d="M3 3h2l2.4 12.3a2 2 0 0 0 2 1.7h6.9a2 2 0 0 0 2-1.6L21 7H6"
                stroke="#7E6E5B"
                stroke-width="1.6"
                stroke-linecap="round"
                stroke-linejoin="round"
              />
              <circle cx="10" cy="20" r="1.5" fill="#7E6E5B" />
              <circle cx="17" cy="20" r="1.5" fill="#7E6E5B" />
            </svg>
          </button>

          <div class="dropdown">
            <div class="dropdown-trigger">
              <button class="dropbtn" id="welcomeMessage">Loading....</button>
              <img
                src="images/down-arrow.png"
                alt="arrow"
                width="30"
                class="dropdown-arrow"
              />
            </div>
            <div class="dropdown-content">
              <a href="profile.html">Profile</a>
              <a href="#" id="logoutBtn">Logout</a>
            </div>
          </div>
        </div>
      </div>
    </header>

  <!-- ðŸ”¹ Cart Content -->
  <main>
    <h1>Your Shopping Cart</h1>
    <div id="cartItems"></div>
    <div id="cartTotal"></div>
  </main>

  <!-- ðŸ”¹ Firebase script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, updateDoc, arrayRemove } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCC_14beDBhudrtoAIFqc29TCMY5zoa4AA",
      authDomain: "prestige-pages.firebaseapp.com",
      projectId: "prestige-pages",
      storageBucket: "prestige-pages.appspot.com",
      messagingSenderId: "1065922943021",
      appId: "1:1065922943021:web:e5829dd09e206063b500a4",
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const cartItemsDiv = document.getElementById("cartItems");
    const cartTotalDiv = document.getElementById("cartTotal");
    const welcomeEl = document.getElementById("welcomeMessage");

    // âœ… Listen for logged in user
    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        window.location.href = "login.html";
        return;
      }

      const docRef = doc(db, "users", user.uid);
      const docSnap = await getDoc(docRef);

      if (docSnap.exists()) {
        const data = docSnap.data();
        const firstName = data.firstName || "User";
        welcomeEl.textContent = `${firstName}`;

        const cart = data.cart || [];
        renderCart(cart, docRef);
      } else {
        cartItemsDiv.innerHTML = "<p>Your cart is empty.</p>";
      }
    });

    // âœ… Render cart items
    async function renderCart(cart, docRef) {
      cartItemsDiv.innerHTML = "";
      let total = 0;

      if (cart.length === 0) {
        cartItemsDiv.innerHTML = "<p>Your cart is empty.</p>";
        cartTotalDiv.innerHTML = "";
        return;
      }

      cart.forEach((item) => {
        total += item.price;

        const div = document.createElement("div");
        div.classList.add("cart-item");
        div.innerHTML = `
          <img src="${item.cover}" width="50"/>
          <div>
            <strong>${item.title}</strong><br>
            <span>by ${item.author}</span><br>
            <span>â‚±${item.price.toLocaleString()}</span>
          </div>
          <button class="removeBtn">Remove</button>
        `;

        // âœ… Remove from cart
        div.querySelector(".removeBtn").addEventListener("click", async () => {
          await updateDoc(docRef, { cart: arrayRemove(item) });
          renderCart(cart.filter(i => i !== item), docRef); // re-render cart
        });

        cartItemsDiv.appendChild(div);
      });

      cartTotalDiv.innerHTML = `<h3>Total: â‚±${total.toLocaleString()}</h3>`;
    }

    // âœ… Logout handler
    document.getElementById("logoutBtn").addEventListener("click", async () => {
      await signOut(auth);
      window.location.href = "login.html";
    });
  </script>
</body>
</html>
