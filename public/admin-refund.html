<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Admin Dashboard — Refund</title>
  <link rel="stylesheet" href="css/admin-prod-management.css" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <style>
    /* small helpers for badges */
    .badge { display:inline-block; padding:.25rem .5rem; border-radius:999px; font-size:.8rem }
    .badge.success{ background:#e7f7ef; color:#16794c }
    .badge.muted{ background:#f1f1f1; color:#666 }
  </style>
</head>

<body>
  <div class="dashboard-layout">
    <!-- Sidebar -->
    <nav class="sidebar">
      <a href="index.html" class="brand">Prestige Pages</a>
      <a href="admin-orders.html">Orders</a>
      <a href="admin-prod-management.html">Inventory</a>
      <a href="admin-customer.html">Customers</a>
      <a href="admin-transaction-management.html">Transactions</a>
      <a href="admin-refund.html" class="active">Refund</a>
      <a href="admin-faq.html">Customer Service</a>
    </nav>

    <!-- Main -->
    <main class="main-content">
      <h2>Refund Management</h2>

      <!-- Refund Requests (pending / processing) -->
      <section class="product-list">
        <h3>Refund Requests</h3>
        <table>
          <thead>
            <tr>
              <th>Refund #</th>
              <th>Order #</th>
              <th>Customer</th>
              <th>Amount</th>
              <th>Method</th>
              <th>Status</th>
              <th>Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="refundRequests">
            <!-- request rows injected -->
          </tbody>
        </table>
      </section>

      <!-- Refund List (processed: refunded / rejected) -->
      <section class="product-list" style="margin-top:2rem;">
        <h3>Refund List</h3>
        <table>
          <thead>
            <tr>
              <th>Refund #</th>
              <th>Order #</th>
              <th>Customer</th>
              <th>Amount</th>
              <th>Method</th>
              <th>Status</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody id="refundHistory">
            <!-- history rows injected -->
          </tbody>
        </table>
      </section>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    import { firebaseConfig } from "./js/firebase-config.js";

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const peso = v => "₱" + Number(v || 0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});

    async function loadRefunds(){
      const reqBody = document.querySelector('#refundRequests');
      const histBody = document.querySelector('#refundHistory');
      const reqColSpan = reqBody.closest('table')?.querySelectorAll('thead th').length || 8;
      const histColSpan = histBody.closest('table')?.querySelectorAll('thead th').length || 7;
      reqBody.innerHTML = `<tr class="loading"><td colspan="${reqColSpan}" style="text-align:center; padding:12px;"><i class='fas fa-spinner fa-spin'></i> Loading requests...</td></tr>`;
      histBody.innerHTML = `<tr class="loading"><td colspan="${histColSpan}" style="text-align:center; padding:12px;"><i class='fas fa-spinner fa-spin'></i> Loading history...</td></tr>`;

      const users = await getDocs(collection(db, 'users'));
      const requests = []; // refund-processing
      const history = [];  // refunded, refund-rejected

      for (const u of users.docs){
        const uid = u.id; const udata = u.data()||{}; const name = `${udata.firstName||''} ${udata.lastName||''}`.trim() || udata.email || uid;
        const txs = await getDocs(collection(db, 'users', uid, 'transactions'));
        txs.forEach(d => {
          const t = d.data()||{};
            const deliv = (t.delivstatus||'').toString().toLowerCase();
            const base = { uid, id: d.id, name, amount: t.total||0, method: t.paymentMethod||'', date: (t.createdAt?.toDate?t.createdAt.toDate().toLocaleString():'' )};
            if (deliv === 'refund-processing'){
              requests.push({ ...base, status: 'Processing' });
            } else if (deliv === 'refunded' || deliv === 'refund-rejected') {
              history.push({ ...base, status: deliv === 'refunded' ? 'Refunded' : 'Rejected', raw: deliv });
            }
        });
      }

      // Populate requests table
      if (requests.length === 0){
        reqBody.innerHTML = `<tr><td colspan="${reqColSpan}" style="padding:14px; text-align:center; color:#666;">No refund requests found.</td></tr>`;
      } else {
        reqBody.innerHTML = requests.map(r=>`
          <tr>
            <td>${r.id}</td>
            <td>${r.id}</td>
            <td>${r.name}</td>
            <td>${peso(r.amount)}</td>
            <td>${r.method}</td>
            <td><span class="badge muted">${r.status}</span></td>
            <td>${r.date}</td>
            <td>
              <button class="btn btn-sm view-refund" data-uid="${r.uid}" data-id="${r.id}"><i class="fa fa-eye"></i> View</button>
            </td>
          </tr>`).join('');
      }

      // Populate history table
      if (history.length === 0){
        histBody.innerHTML = `<tr><td colspan="${histColSpan}" style="padding:14px; text-align:center; color:#666;">No processed refunds yet.</td></tr>`;
      } else {
        histBody.innerHTML = history.map(r=>`
          <tr>
            <td>${r.id}</td>
            <td>${r.id}</td>
            <td>${r.name}</td>
            <td>${peso(r.amount)}</td>
            <td>${r.method}</td>
            <td>${r.status === 'Refunded' ? '<span class="badge success">Refunded</span>' : '<span class="badge error">Rejected</span>'}</td>
            <td>${r.date}</td>
          </tr>`).join('');
      }

      // Attach action handler for view button
      reqBody.addEventListener('click', async (e)=>{
        const view = e.target.closest('.view-refund');
        if (view){
          const uid = view.getAttribute('data-uid');
          const id = view.getAttribute('data-id');
          if (!uid || !id) return;
          try {
            CURRENT_REFUND_UID = uid;
            CURRENT_REFUND_TXID = id;
            await populateRefundModal(uid,id);
            openRefundModal();
          } catch(err){
            console.error(err);
            alert('Failed to load refund details');
          }
        }
      });
    }

    loadRefunds();
    // --- Refund View Modal Logic ---
    let CURRENT_REFUND_UID = null;
    let CURRENT_REFUND_TXID = null;
    function qs(id){ return document.getElementById(id); }
    const refundModal = document.createElement('div');
    refundModal.id = 'refundViewModal';
    refundModal.className = 'modal';
    refundModal.style.display='none';
    refundModal.innerHTML = `
      <div class="modal-content" style="max-width:520px;">
        <h2 style="margin-top:0; display:flex; justify-content:space-between; align-items:center;">Refund Request <span id="closeRefundView" class="close-btn" style="cursor:pointer;">&times;</span></h2>
        <div style="font-size:14px; line-height:1.4; margin-bottom:12px; color:#555;">
          Below is the customer's stated reason for requesting a refund. Review and choose an action.
        </div>
        <div style="margin-bottom:16px;">
          <label style="font-size:12px; font-weight:600; letter-spacing:.5px; text-transform:uppercase; color:#666;">Reason</label>
          <div id="refundReasonDisplay" style="white-space:pre-wrap; border:1px solid var(--line,#ddd); background:#fafafa; padding:12px 14px; border-radius:8px; min-height:80px; font-size:14px;"></div>
        </div>
        <div id="refundModalMsg" style="min-height:18px; font-size:12px; color:#b30000;"></div>
        <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:6px;">
          <button type="button" class="btn secondary" id="refundRejectBtn"><i class="fa fa-times"></i> Reject</button>
          <button type="button" class="btn" id="refundApproveBtn"><i class="fa fa-check"></i> Approve</button>
        </div>
      </div>`;
    document.body.appendChild(refundModal);

    function openRefundModal(){ refundModal.style.display='flex'; }
    function closeRefundModal(){ refundModal.style.display='none'; CURRENT_REFUND_UID=null; CURRENT_REFUND_TXID=null; qs('refundReasonDisplay').textContent=''; }
    window.addEventListener('click', (e)=>{ if (e.target === refundModal) closeRefundModal(); });
    refundModal.querySelector('#closeRefundView').addEventListener('click', closeRefundModal);

    async function populateRefundModal(uid, txid){
      const snap = await getDocs(collection(db,'users', uid, 'transactions'));
      let reason = '(Not found)';
      snap.forEach(d=>{ if (d.id === txid){ const data = d.data()||{}; reason = data.refundReason || '(No reason provided)'; }});
      qs('refundReasonDisplay').textContent = reason;
    }

    async function approveRefund(){
      if (!CURRENT_REFUND_UID || !CURRENT_REFUND_TXID) return;
      try {
        await updateDoc(doc(db,'users',CURRENT_REFUND_UID,'transactions',CURRENT_REFUND_TXID), { delivstatus:'refunded', refundApprovedAt: serverTimestamp() });
        closeRefundModal();
        loadRefunds();
      } catch(err){
        qs('refundModalMsg').textContent = 'Failed to approve refund';
        console.error(err);
      }
    }
    async function rejectRefund(){
      if (!CURRENT_REFUND_UID || !CURRENT_REFUND_TXID) return;
      try {
        await updateDoc(doc(db,'users',CURRENT_REFUND_UID,'transactions',CURRENT_REFUND_TXID), { delivstatus:'refund-rejected', refundRejectedAt: serverTimestamp() });
        closeRefundModal();
        loadRefunds();
      } catch(err){
        qs('refundModalMsg').textContent = 'Failed to reject refund';
        console.error(err);
      }
    }
    refundModal.querySelector('#refundApproveBtn').addEventListener('click', approveRefund);
    refundModal.querySelector('#refundRejectBtn').addEventListener('click', rejectRefund);
  </script>
</body>
</html>
